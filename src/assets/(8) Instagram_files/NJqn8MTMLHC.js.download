;/*FB_PKG_DELIM*/

__d("LSDeleteMessage",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(n){return t.forEach(t.filter(t.db.table(12).fetch([[[e[1]]],"messageId"]),function(n){return n.messageId===e[1]&&t.i64.eq(n.threadKey,e[0])}),function(e){return e.delete()})},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxDeleteMessageStoredProcedure",e.__tables__=["messages"],a.exports=e}),null);
__d("LSHandleRepliesOnRemove",["LSDeleteMessage"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(r){return t.sequence([function(r){return t.forEach(t.filter(t.db.table(12).fetch([[[e[1]]],"replySourceIdMessageID"]),function(n){return t.i64.eq(n.threadKey,e[0])&&n.replySourceId===e[1]&&t.i64.eq(n.replyType,t.i64.cast([0,1]))}),function(e){var r=e.item;return t.storedProcedure(n("LSDeleteMessage"),r.threadKey,r.messageId)})},function(n){return t.forEach(t.filter(t.db.table(12).fetch([[[e[1]]],"replySourceIdMessageID"]),function(n){return t.i64.eq(n.threadKey,e[0])&&n.replySourceId===e[1]}),function(e){var n=e.item;return t.forEach(t.filter(t.db.table(12).fetch([[[n.threadKey,n.timestampMs,n.messageId]]]),function(e){return t.i64.eq(e.threadKey,n.threadKey)&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(e.timestampMs,n.timestampMs)&&e.messageId===n.messageId}),function(e){var t=e.update,n=e.item;return t({replySourceId:void 0,replySourceTimestampMs:void 0,replySourceType:void 0,replySourceTypeV2:void 0,replySnippet:void 0,replyStatus:void 0,replyToUserId:void 0,replyMessageText:void 0,replyMediaExpirationTimestampMs:void 0,replyMediaUrl:void 0,replyMediaUrlFallback:void 0,replyMediaPreviewWidth:void 0,replyMediaPreviewHeight:void 0,replyMediaUrlMimeType:void 0,replyAttachmentType:void 0,replyAttachmentId:void 0,replyAttachmentExtra:void 0})})})}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxHandleRepliesOnRemoveStoredProcedure",e.__tables__=["messages"],a.exports=e}),null);
__d("LSRefreshLastActivityTimestamp",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(r){return t.sequence([function(r){return t.db.table(12).fetchDesc([[[e[0]]]]).next().then(function(e,r){var o=e.done,a=e.value;return o?n[0]=t.i64.cast([0,0]):(r=a.item,n[0]=r.timestampMs)})},function(r){return t.db.table(9).fetch([[[e[0]]]]).next().then(function(e,r){var o=e.done,a=e.value;return o?n[2]=t.i64.cast([0,0]):(r=a.item,n[2]=r.lastActivityTimestampMs)})},function(r){return t.i64.neq(n[0],t.i64.cast([0,0]))&&t.i64.neq(n[0],n[2])?t.forEach(t.db.table(9).fetch([[[e[0]]]]),function(e){var t=e.update,r=e.item;return t({lastActivityTimestampMs:n[0]})}):t.resolve()}])},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxRefreshLastActivityTimestampStoredProcedure",e.__tables__=["messages","threads"],a.exports=e}),null);
__d("LSUpdateThreadSnippetFromLastMessage",["LSGetThreadParticipantDisplayName","LSUpdateThreadSnippetFromLastMessageV2"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(o){return r[0]=!0,r[0]&&!e[11]?t.sequence([function(r){return t.storedProcedure(n("LSUpdateThreadSnippetFromLastMessageV2"),e[1])},function(e){return r[1]=!1}]):t.resolve(r[1]=!0)},function(o){return r[1]?t.db.table(12).fetchDesc([[[e[1]]]]).next().then(function(o,a){var i=o.done,l=o.value;return i?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(e){var t=e.update,n=e.item;return t({snippet:void 0,snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:!1,snippetSenderContactId:void 0})}):(a=l.item,t.sequence([function(n){return r[5]=a.text,r[9]=a.threadKey,r[10]=t.i64.cast([0,0]),r[11]=a.messageId,r[13]=a.senderId,r[6]=a.stickerId,r[12]=a.isAdminMessage,r[8]=a.isUnsent,r[7]=a.messageHiddenState,t.count(t.filter(t.db.table(9).fetch([[[e[1]]]]),function(n){return t.i64.eq(e[1],n.threadKey)&&t.i64.eq(t.i64.cast([0,2]),n.threadType)})).then(function(e){return r[3]=e})},function(n){return r[12]?t.resolve(r[4]=t.i64.cast([0,9])):t.sequence([function(n){return t.i64.eq(r[13],e[0])?t.sequence([function(e){return r[8]?t.resolve(r[15]=t.i64.cast([0,3])):t.sequence([function(e){return t.i64.eq(r[7],t.i64.cast([0,1]))?t.resolve(r[16]=t.i64.cast([0,12])):t.sequence([function(e){return r[5]!==void 0&&r[5]!==""?t.resolve(r[17]=t.i64.cast([0,0])):t.sequence([function(e){return t.i64.neq(r[6],void 0)?t.resolve(r[18]=t.i64.cast([0,2])):t.sequence([function(e){return t.filter(t.db.table(16).fetch([[[r[9],r[11]]]]),function(e){return t.i64.eq(e.threadKey,r[9])&&t.i64.eq(t.i64.cast([0,0]),r[10])&&e.messageId===r[11]}).next().then(function(e,n){var o=e.done,a=e.value;return o?r[19]=t.i64.cast([0,1]):(n=a.item,t.i64.eq(n.attachmentType,t.i64.cast([0,2]))?r[21]=t.i64.cast([0,10]):r[21]=t.i64.cast([0,1]),r[19]=r[21])})},function(e){return r[18]=r[19]}])},function(e){return r[17]=r[18]}])},function(e){return r[16]=r[17]}])},function(e){return r[15]=r[16]}])},function(e){return r[14]=r[15]}]):t.sequence([function(e){return r[8]?t.resolve(r[15]=t.i64.cast([0,8])):t.sequence([function(e){return t.i64.eq(r[7],t.i64.cast([0,1]))?t.resolve(r[16]=t.i64.cast([0,12])):t.sequence([function(e){return r[5]!==void 0&&r[5]!==""?t.resolve((t.i64.eq(r[3],t.i64.cast([0,1]))?r[18]=t.i64.cast([0,5]):r[18]=t.i64.cast([0,4]),r[17]=r[18])):t.sequence([function(e){return t.i64.neq(r[6],void 0)?t.resolve(r[18]=t.i64.cast([0,7])):t.sequence([function(e){return t.filter(t.db.table(16).fetch([[[r[9],r[11]]]]),function(e){return t.i64.eq(e.threadKey,r[9])&&t.i64.eq(t.i64.cast([0,0]),r[10])&&e.messageId===r[11]}).next().then(function(e,n){var o=e.done,a=e.value;return o?r[19]=t.i64.cast([0,6]):(n=a.item,t.i64.eq(n.attachmentType,t.i64.cast([0,2]))?r[21]=t.i64.cast([0,11]):r[21]=t.i64.cast([0,6]),r[19]=r[21])})},function(e){return r[18]=r[19]}])},function(e){return r[17]=r[18]}])},function(e){return r[16]=r[17]}])},function(e){return r[15]=r[16]}])},function(e){return r[14]=r[15]}])},function(e){return r[4]=r[14]}])},function(o){return t.i64.eq(r[4],t.i64.cast([0,0]))?(r[15]=r[5]===""?void 0:r[5],r[15]!==void 0?r[14]=[e[2],": ",r[15]].join(""):r[14]=void 0,t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(e){var t=e.update,n=e.item;return t({snippet:r[14],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})})):t.i64.eq(r[4],t.i64.cast([0,1]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(t){var n=t.update,o=t.item;return n({snippet:e[5],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.i64.eq(r[4],t.i64.cast([0,10]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(t){var n=t.update,o=t.item;return n({snippet:e[7],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.i64.eq(r[4],t.i64.cast([0,2]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(t){var n=t.update,o=t.item;return n({snippet:e[3],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.i64.eq(r[4],t.i64.cast([0,3]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(t){var n=t.update,o=t.item;return n({snippet:e[9],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.i64.eq(r[4],t.i64.cast([0,4]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(e){var t=e.update,n=e.item;return t({snippet:r[5],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.i64.eq(r[4],t.i64.cast([0,5]))?t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[1],r[13]).then(function(e){var t;return t=e,r[14]=t[0],t})},function(n){return r[16]=r[5]===""?void 0:r[5],r[16]!==void 0?r[15]=[r[14],": ",r[16]].join(""):r[15]=void 0,t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(e){var t=e.update,n=e.item;return t({snippet:r[15],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})})}]):t.i64.eq(r[4],t.i64.cast([0,6]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(t){var n=t.update,o=t.item;return n({snippet:e[6],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.i64.eq(r[4],t.i64.cast([0,11]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(t){var n=t.update,o=t.item;return n({snippet:e[8],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.i64.eq(r[4],t.i64.cast([0,7]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(t){var n=t.update,o=t.item;return n({snippet:e[4],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.i64.eq(r[4],t.i64.cast([0,8]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(t){var n=t.update,o=t.item;return n({snippet:e[10],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.i64.eq(r[4],t.i64.cast([0,9]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(e){var t=e.update,n=e.item;return t({snippet:r[5],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.i64.eq(r[4],t.i64.cast([0,12]))?t.forEach(t.db.table(9).fetch([[[e[1]]]]),function(e){var t=e.update,n=e.item;return t({snippet:"",snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:r[12],snippetSenderContactId:r[13]})}):t.resolve(0)}]))}):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxUpdateThreadSnippetFromLastMessageStoredProcedure",e.__tables__=["messages","threads","attachments"],a.exports=e}),null);